â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        FLUXO COMPLETO DE PROCESSAMENTO - MP RECEBÃVEIS V3                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ORDEM DE PROCESSAMENTO:

1. SETTLEMENT PROCESSOR
   â†“
2. RELEASES PROCESSOR
   â†“
3. MOVEMENTS PROCESSOR
   â†“
4. RECONCILIADOR (Etapas 4.1 â†’ 4.2 â†’ 4.3 â†’ 4.4 â†’ 4.5)
   â†“
5. CASHFLOW CALCULATOR


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SETTLEMENT PROCESSOR (LÃª: data/settlement/*.xlsx)

INPUT:
â”œâ”€ 202501s.xlsx (60 linhas)
â”œâ”€ 202502s.xlsx (144 linhas)
â”œâ”€ ... 11 arquivos no total
â””â”€ TOTAL: 10,266 transaÃ§Ãµes

PROCESSA:
1. Ler Excel com pandas
2. Para cada transaÃ§Ã£o:
   a. external_reference = ID do pedido
   b. TRANSACTION_TYPE = tipo (SETTLEMENT, REFUND, CHARGEBACK, etc.)
   c. DESCRIPTION = detalhe (INSTALLMENT, payment, etc.)

3. Agrupar por external_reference:
   â”œâ”€ SETTLEMENT row â†’ dados principais do pedido
   â”œâ”€ INSTALLMENT rows â†’ criar parcelas
   â”œâ”€ REFUND rows â†’ somar refund total
   â””â”€ CHARGEBACK rows â†’ somar chargeback total

4. Para cada parcela:
   â””â”€ installment_net_amount_original = valor original (NÃƒO MUDA NUNCA!)
   â””â”€ installment_net_amount = mesmo valor (serÃ¡ ajustado depois no reconciliador)
   â””â”€ refund_applied = 0 (serÃ¡ calculado depois!)
   â””â”€ status = 'pending' (serÃ¡ ajustado depois!)

5. Salvar em order_balances:
   â”œâ”€ refunded = total do refund
   â”œâ”€ refund_date = quando foi aprovado
   â”œâ”€ total_net = total apÃ³s taxas
   â”œâ”€ final_net = apÃ³s refunds/chargebacks
   â””â”€ etc.

OUTPUT:
â”œâ”€ installments: 7,690 items
â”œâ”€ order_balances: 2,290 items
â””â”€ payment_types: mapeamento

âš ï¸ IMPORTANTE: Refunds/chargebacks NÃƒO sÃ£o aplicados em parcelados aqui!
   Apenas em pagamentos Ã  vista (single installment).
   Parcelados esperam pelo reconciliador.


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RELEASES PROCESSOR (LÃª: data/recebimentos/*.xlsx)

INPUT:
â”œâ”€ 202501r.xlsx (79 releases)
â”œâ”€ 202502r.xlsx (77 releases)
â”œâ”€ ... 11 arquivos no total
â””â”€ TOTAL: 6,098 releases

LEITURA:
Para cada linha:
â”œâ”€ release_date (quando recebeu)
â”œâ”€ approval_date (quando foi aprovado)
â”œâ”€ external_reference (link com pedido)
â”œâ”€ description (tipo: payment, refund, payout, etc.)
â”œâ”€ net_credit_amount (quanto entrou)
â”œâ”€ net_debit_amount (quanto saiu)
â””â”€ etc.

CATEGORIZAÃ‡ÃƒO:
â”œâ”€ description = 'payment' â”€â”
â”œâ”€ description = 'release' â”€â”¼â”€â†’ payments_only (5,407 items)
â”œâ”€ record_type = 'SETTLEMENT' â”¤   â””â”€ Geram receivables (match com installments)
â”œâ”€ description = 'credit_card' â”¤
â””â”€ etc. â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”œâ”€ description = 'refund' â”€â”€â”€â”€â”
â”œâ”€ description = 'chargeback' â”¼â”€â†’ movements (691 items)
â”œâ”€ description = 'payout' â”€â”€â”€â”€â”¤   â””â”€ OperaÃ§Ãµes internas (nÃ£o precisam match)
â”œâ”€ description = 'reserve_...' â”¤
â””â”€ description = 'fee-...' â”€â”€â”€â”€â”˜

OUTPUT:
â”œâ”€ payments_only: 5,407 items (PAYMENTS que geram receivables)
â”œâ”€ movements: 691 items (operaÃ§Ãµes internas)
â””â”€ releases: todos misturados (6,098)

â­ CRITICAL: use release_date para match, nÃ£o approval_date!
   â””â”€ release_date = quando dinheiro chegou na conta
   â””â”€ approval_date = quando foi autorizado


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MOVEMENTS PROCESSOR (Apenas informativo)

INPUT: movements list (691 items)

OUTPUT: Resumo de movimentaÃ§Ãµes internas

âš ï¸ NÃƒO impacta as parcelas, apenas informativo.


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RECONCILIADOR V3 (5 PASSOS)

INPUT:
â”œâ”€ installments: 7,690 (do settlement)
â”œâ”€ payments: 5,407 (do releases)
â””â”€ order_balances: 2,290 (do settlement)


â”Œâ”€ PASSO 1: Calcular Saldos por Pedido
â”‚  â””â”€ Para cada pedido:
â”‚     â”œâ”€ Saldo Esperado = sum(installment_net_amount_original)
â”‚     â”œâ”€ Saldo Recebido = sum(payment net_credit_amount)
â”‚     â””â”€ DiferenÃ§a = quanto falta

â”œâ”€ PASSO 2: Reconciliar cada Pedido
â”‚  â””â”€ Para cada pedido:
â”‚     â”œâ”€ Ordenar parcelas por money_release_date (vencimento)
â”‚     â”œâ”€ Ordenar pagamentos por release_date (quando recebeu)
â”‚     â”œâ”€ Fazer match: pagamento 1 â†’ parcela 1, etc.
â”‚     â””â”€ Determinar status:
â”‚        â”œâ”€ received_advance (recebeu antes do vencimento)
â”‚        â”œâ”€ received (recebeu na data)
â”‚        â”œâ”€ overdue (venceu e nÃ£o recebeu)
â”‚        â””â”€ pending (nÃ£o recebeu ainda)

â”œâ”€ PASSO 3: Aplicar Saldo Progressivo com Refunds
â”‚  â””â”€ Para cada pedido com refund:
â”‚     â”œâ”€ Comparar: refund_date vs first_payment_date
â”‚     â”œâ”€ Se refund_date <= first_payment_date:
â”‚     â”‚  â””â”€ Distribuir refund em TODAS as parcelas
â”‚     â”œâ”€ Se refund_date > first_payment_date:
â”‚     â”‚  â””â”€ Distribuir refund APENAS em nÃ£o recebidas
â”‚     â””â”€ Para cada parcela:
â”‚        â”œâ”€ new_amount = original - refund_per_parcel
â”‚        â”œâ”€ Se new_amount <= 0:
â”‚        â”‚  â””â”€ Marcar como cancelled
â”‚        â””â”€ refund_applied = refund_per_parcel (A FRAÃ‡ÃƒO, nÃ£o total!)

â”œâ”€ PASSO 4: Garantir Status Correto de Canceladas
â”‚  â””â”€ Para cada parcela com is_cancelled = True:
â”‚     â””â”€ ForÃ§ar status = 'cancelled'

â””â”€ PASSO 5: Gerar EstatÃ­sticas
   â””â”€ Contar por status:
      â”œâ”€ received: 2,785
      â”œâ”€ received_advance: 2,340
      â”œâ”€ pending: 2,458
      â”œâ”€ overdue: 12
      â”œâ”€ cancelled: 95
      â”œâ”€ Pedidos fechados: 1,183 (100% recebido)
      â””â”€ Pedidos abertos: 1,053 (parcialmente recebido)

OUTPUT: installments com status final atualizado


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CASHFLOW CALCULATOR V2

INPUT: installments com status final

PROCESSA:
â”œâ”€ Para cada installment:
â”‚  â”œâ”€ money_release_date = quando libera
â”‚  â””â”€ installment_net_amount = quanto libera

OUTPUT: AnÃ¡lise de cash flow


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”‘ ERROS CONHECIDOS E SOLUÃ‡Ã•ES:

1. "Parcela 4/4 estÃ¡ cancelada, mas deveria estar pendente"
   â”œâ”€ CAUSA: refund_date == first_payment_date
   â”‚          Usar < em vez de <=
   â”‚          Refund nÃ£o foi distribuÃ­do em todas
   â”œâ”€ SOLUÃ‡ÃƒO: Alterar para refund_date <= first_payment_date
   â””â”€ FIX: reconciliator.py linha 744

2. "Parcela marcada como overdue, mas Ã© cancelled"
   â”œâ”€ CAUSA: Status atribuÃ­do antes de descobrir que Ã© cancelada
   â”œâ”€ SOLUÃ‡ÃƒO: Chamar _ensure_cancelled_status() ao final
   â””â”€ FIX: reconciliator.py linha 117

3. "Refund nÃ£o estÃ¡ sendo distribuÃ­do"
   â”œâ”€ CAUSA 1: refund_date ou first_payment_date em formato errado
   â”œâ”€ CAUSA 2: order_balances nÃ£o tem a key 'refunded'
   â”œâ”€ SOLUÃ‡ÃƒO: Usar _parse_date_safe() para converter datas
   â””â”€ FIX: reconciliator.py linhas 738-740

4. "Payments nÃ£o encontram as parcelas"
   â”œâ”€ CAUSA: external_reference diferente (espaÃ§os, maiÃºsculas)
   â”œâ”€ SOLUÃ‡ÃƒO: Comparar sem espaÃ§os, case-insensitive
   â””â”€ FIX: Adicionar .strip().lower() ao fazer match

5. "refund_applied mostra valor total em vez da fraÃ§Ã£o"
   â”œâ”€ CAUSA: Atribuindo total_refund em vez de refund_per_inst
   â”œâ”€ SOLUÃ‡ÃƒO: Verificar se refund_per_inst estÃ¡ correto
   â””â”€ FIX: reconciliator.py linha 793

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
